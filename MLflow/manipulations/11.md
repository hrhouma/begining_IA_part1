### Tutoriel Complet : Configuration de S3 après PostgreSQL sur une Machine Virtuelle Ubuntu 22.04

## Objectif

L'objectif de ce tutoriel est de vous guider dans la configuration de S3 comme stockage des artefacts après avoir configuré PostgreSQL comme backend store sur une machine virtuelle Ubuntu 22.04 pour MLflow.

## Prérequis

- Une machine virtuelle Ubuntu 22.04
- PostgreSQL installé et configuré
- AWS CLI installé et configuré
- Un bucket S3 créé sur AWS

## Étapes

### 1. Installation de PostgreSQL

Si PostgreSQL n'est pas encore installé sur votre machine virtuelle, vous pouvez l'installer en suivant ces étapes :

```bash
sudo apt update
sudo apt install postgresql postgresql-contrib
```

Vérifiez que PostgreSQL est en cours d'exécution :

```bash
sudo systemctl start postgresql
sudo systemctl enable postgresql
```

### 2. Configuration de PostgreSQL

Créez une base de données et un utilisateur pour MLflow :

```bash
sudo -u postgres psql
```

Dans l'invite PostgreSQL, exécutez les commandes suivantes :

```sql
CREATE DATABASE mlflowdb;
CREATE USER mlflowuser WITH ENCRYPTED PASSWORD 'yourpassword';
GRANT ALL PRIVILEGES ON DATABASE mlflowdb TO mlflowuser;
```

Remplacez `yourpassword` par un mot de passe sécurisé.

### 3. Installation d'AWS CLI

Installez AWS CLI en suivant ces étapes :

```bash
sudo apt update
sudo apt install awscli -y
```

Configurez AWS CLI avec vos identifiants AWS :

```bash
aws configure
```

Entrez vos `AWS Access Key ID`, `AWS Secret Access Key`, `Default region name`, et `Default output format`.

### 4. Configuration de S3

1. **Créer un Bucket S3**

   Connectez-vous à votre console AWS, allez à S3, et créez un bucket. Notez le nom du bucket.

2. **Configurer les Permissions IAM**

   Assurez-vous que votre utilisateur IAM dispose des permissions nécessaires pour accéder au bucket S3. Voici un exemple de politique IAM :

   ```json
   {
     "Version": "2012-10-17",
     "Statement": [
       {
         "Effect": "Allow",
         "Action": [
           "s3:ListBucket",
           "s3:GetObject",
           "s3:PutObject"
         ],
         "Resource": [
           "arn:aws:s3:::mlflow-artifacts-bucket",
           "arn:aws:s3:::mlflow-artifacts-bucket/*"
         ]
       }
     ]
   }
   ```

### 5. Lancer le Serveur MLflow

Utilisez la commande suivante pour lancer le serveur MLflow avec PostgreSQL comme backend store et S3 comme stockage des artefacts :

```bash
mlflow server --backend-store-uri postgresql://mlflowuser:yourpassword@localhost/mlflowdb \
              --default-artifact-root s3://mlflow-artifacts-bucket \
              --host 0.0.0.0 \
              --port 5000 \
              --no-serve-artifacts
```

Remplacez `yourpassword` par le mot de passe de votre utilisateur PostgreSQL et `mlflow-artifacts-bucket` par le nom de votre bucket S3.

### 6. Vérifier l'Accès

Accédez à l'interface MLflow dans votre navigateur à l'adresse suivante :

```
http://<IP-de-votre-VM>:5000
```

### Exemple Complet de Commande

Voici un exemple de script complet pour lancer le serveur MLflow avec PostgreSQL et S3 :

```bash
# Lancer le serveur MLflow avec PostgreSQL comme backend store et S3 comme stockage des artefacts
mlflow server --backend-store-uri postgresql://mlflowuser:yourpassword@localhost/mlflowdb \
              --default-artifact-root s3://mlflow-artifacts-bucket \
              --host 0.0.0.0 \
              --port 5000 \
              --no-serve-artifacts
```

### Conclusion

En suivant ces étapes, vous avez configuré PostgreSQL comme backend store et S3 comme stockage des artefacts pour MLflow sur une machine virtuelle Ubuntu 22.04. Vous pouvez maintenant suivre et gérer vos expériences de machine learning en utilisant une configuration robuste et évolutive.
